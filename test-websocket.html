<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status">Disconnected</div>
    <div id="messages"></div>
    <button onclick="testConnection()">Test Connection</button>
    
    <script>
        const status = document.getElementById('status');
        const messages = document.getElementById('messages');
        
        function log(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            messages.appendChild(div);
            console.log(message);
        }
        
        function testConnection() {
            messages.innerHTML = '';
            log('Starting WebSocket connection test...');
            
            try {
                const wsUrl = 'ws://localhost:8000/ws/booking-updates';
                log('Attempting to connect to: ' + wsUrl);
                
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    log('✅ WebSocket connected successfully!');
                    status.textContent = 'Connected';
                    status.style.color = 'green';
                    
                    // Send a test message
                    const testMessage = {
                        type: 'subscribe',
                        date: '2025-07-01'
                    };
                    
                    ws.send(JSON.stringify(testMessage));
                    log('📤 Sent subscription message: ' + JSON.stringify(testMessage));
                    
                    // Send ping
                    setTimeout(() => {
                        ws.send(JSON.stringify({ type: 'ping' }));
                        log('📤 Sent ping message');
                    }, 1000);
                };
                
                ws.onmessage = function(event) {
                    log('📥 Received message: ' + event.data);
                    try {
                        const data = JSON.parse(event.data);
                        log('📥 Parsed message type: ' + data.type);
                    } catch (e) {
                        log('❌ Could not parse message as JSON');
                    }
                };
                
                ws.onclose = function(event) {
                    log('🔌 WebSocket closed: Code=' + event.code + ', Reason=' + event.reason);
                    status.textContent = 'Disconnected';
                    status.style.color = 'red';
                };
                
                ws.onerror = function(error) {
                    log('❌ WebSocket error: ' + error);
                    log('❌ WebSocket readyState: ' + ws.readyState);
                    console.error('WebSocket error:', error);
                };
                
                // Test readyState
                setTimeout(() => {
                    log('📊 WebSocket readyState after 100ms: ' + ws.readyState);
                }, 100);
                
            } catch (error) {
                log('❌ Failed to create WebSocket: ' + error);
                console.error('WebSocket creation error:', error);
            }
        }
        
        // Test immediately on load
        testConnection();
    </script>
</body>
</html>
